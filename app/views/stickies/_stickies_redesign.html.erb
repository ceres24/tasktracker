<% @project = current_user.all_viewable_projects.find_by_id(params[:project_id]) %>
<% @board = @project.boards.find_by_id(params[:board_id]) if @project %>
<% @tags = @project.tags.where(id: params[:tag_ids]) if @project %>

<div style="clear:both"></div>


<div class="pull-left" style="margin-top: 10px; margin-bottom: 10px; margin-left: 20px; padding: 2px 5px;">
  <%= check_box_tag "check-all", '1', false, data: { object: 'check-all-stickies' }, style: 'float:left;margin-left:-20px' %>

  <div style="float:left;margin-right:5px;white-space:nowrap">
    <span style="font-weight:200;font-size:20px;"><%= @board ? @board.name : (params[:board_id] == '0' ? 'Holding Pen' : 'All Stickies') %></span>
    <%= link_to 'Mark Completed', '#', class: 'btn btn-mini', data: { object: 'count-stickies' } %>
    <% @tags.each do |tag| %><%= @tag = tag; render partial: 'tags/show' %><% end %>
  </div>

</div>
<div class="btn-toolbar pull-right">
  <div class="btn-group">
    <button id="assigned-to-me-btn" class="btn <%= 'active' if params[:assigned_to_me] == '1' %> btn-mini" data-object="update-board-count">Assigned To Me</button>
  </div>

  <div class="btn-group" data-toggle="buttons-radio">
    <% ['completed', 'past_due', 'upcoming'].each do |scope| %>
      <button data-object="set-scope" data-value="<%= scope %>" class="btn <%= 'active' if params[:scope] == scope %> btn-mini"><%= scope.humanize %></button>
    <% end %>
  </div>
</div>

<% if @stickies.count > 0 %>
  <div class="pull-right" style="margin-top: 10px; margin-bottom: 10px; margin-left:20px; font-size:11px; padding: 2px 6px">
    <span id="scope-direction-icon"><%= '&larr;'.html_safe if params[:scope_direction] == 'reverse' %></span> <span data-object="toggle-scope-direction" style="cursor:pointer" rel="tooltip" title="Toggle Direction"><%= @stickies.count %> of <%= @count %></span>
  </div>
<% end %>


<div style="clear:both"></div>

<% if @stickies.count > 0 %>
  <table class="table table-condensed" style="width:100%;table-layout: fixed;"><col width="20px"/><col /><col width="40px"/><col width="80px"/><col width="60px"/>
    <% @stickies.each do |sticky| %>
      <tr class="<%= sticky.completed? ? 'sticky-completed' : 'sticky-not-completed' %>" id="sticky_<%= sticky.id %>_row">
        <td><%= check_box_tag "sticky_ids[#{sticky.id}]", '1', false, style: 'margin:0px', data: { object: 'sticky-checkbox', sticky_id: sticky.id } %></td>
        <td data-link="<%= sticky_path(sticky) %>" data-remote="true" data-method="get" style="cursor:pointer;white-space:nowrap;overflow-x:hidden;">
          <div id="sticky_<%= sticky.id %>" data-object="sticky-draggable" data-sticky-id="<%= sticky.id %>" data-board-id="<%= sticky.board ? sticky.board.id : 0 %>" style="overflow:hidden">
            <span><% sticky.tags.each do |tag| %><%= @tag = tag; render partial: 'tags/show' %><% end %></span> <%= strip_tags(sticky.full_description) %>
            <div data-object="sticky-helper" style="display:none"><% sticky.tags.each do |tag| %><%= @tag = tag; render partial: 'tags/show' %><% end %> <%= strip_tags(sticky.full_description).truncate(30) %></div>
          </div>
        </td>
        <td><% if sticky.comments.size > 0 %><span class="badge badge-info"><%= sticky.comments.size %></span><% end %></td>
        <td style="white-space:nowrap;overflow-x:hidden;">
          <span rel="tooltip" title="<%= sticky.owner ? sticky.owner.name : 'Unassigned'  %>" data-placement="left">
          <% if sticky.owner %>
            <%= image_tag sticky.owner.avatar_url(18, "identicon") %>
            <%= sticky.owner.nickname %>
          <% else %>
            <%= image_tag User.new.avatar_url(18, "mm") %>
          <% end %>
          </span>
        </td>
        <td style="text-align:right;white-space:nowrap"><span><%= simple_date(sticky.due_date) %></span><%#= " at #{sticky.due_at_string_short}" unless sticky.all_day? %></td>
      </tr>
    <% end %>
  </table>

  <% [false, true].each do |phone| %>
    <center class="<%= phone ? 'visible' : 'hidden' %>-phone"><%= paginate @stickies, theme: phone ? "contour-mini" : "contour" %></center>
  <% end %>
<% else %>
  <center>
    <span class="muted">No stickies found</span>
    <% unless params[:tag_ids].blank? %><div>Filters: <% current_user.all_viewable_tags.where(id: params[:tag_ids].to_s.split(',')).each do |tag| %><%= @tag = tag; render partial: 'tags/show' %><% end %> <%= link_to 'Clear', '#', data: { object: 'clear-tags' }, class: 'btn btn-mini' %></span><% end %>
  </center>
<% end %>
